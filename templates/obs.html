<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Osu! OBS Widget</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* –ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è OBS */
        body { background-color: transparent; overflow: hidden; font-family: 'Segoe UI', sans-serif; margin: 0; }

        :root {
            --bg-url: url('https://osu.ppy.sh/images/layout/beatmaps/default-bg.jpg');
        }

        #widget-container {
            position: fixed; top: 20px; left: 20px; width: 750px;
            opacity: 0; transform: translateX(-50px) scale(0.95);
            transition: all 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none; /* –ß—Ç–æ–±—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–µ –∫–ª–∏–∫–Ω—É—Ç—å –≤ OBS */
        }
        
        /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–≥–¥–∞ –≤–∏–¥–∂–µ—Ç –≤–∏–¥–µ–Ω */
        #widget-container.active { opacity: 1; transform: translateX(0) scale(1); }

        .obs-card {
            position: relative; display: flex; align-items: center;
            background: #1e1e1e; border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.15);
            height: 140px; transition: all 0.5s ease;
            z-index: 1;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞/–ø—Ä–æ–≤–∞–ª–∞ */
        .success-mode .obs-card { border-color: #28a745; box-shadow: 0 0 50px rgba(40, 167, 69, 0.6); }
        .fail-mode .obs-card    { border-color: #dc3545; box-shadow: 0 0 50px rgba(220, 53, 69, 0.6); }

        /* –†–∞–∑–º—ã—Ç—ã–π —Ñ–æ–Ω –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .obs-card::before {
            content: ""; position: absolute; 
            top: -10%; left: -10%; width: 120%; height: 120%;
            background-color: #333; 
            background-image: var(--bg-url);
            background-size: cover; background-position: center;
            filter: blur(15px) brightness(0.4); z-index: -1;
            transition: background-image 0.8s ease;
        }

        /* –ß–µ—Ç–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–µ–≤–∞ */
        .cover-img {
            position: relative; z-index: 2; width: 220px; height: 100%;
            background-color: #111; 
            background-image: var(--bg-url);
            background-size: cover; background-position: center;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5); 
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .info-block {
            position: relative; z-index: 2; flex: 1; padding: 0 25px; color: white;
            display: flex; flex-direction: column; justify-content: center;
            overflow: hidden;
        }

        .label-now { color: #ff66aa; text-transform: uppercase; font-size: 0.8rem; font-weight: 800; letter-spacing: 2px; margin-bottom: 5px; }
        
        .map-title { 
            font-size: 1.5rem; font-weight: 700; line-height: 1.2; margin-bottom: 5px; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.8); 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }

        .requester { font-size: 1rem; color: #ddd; }

        /* –û–≤–µ—Ä–ª–µ–π —Å—Ç–∞—Ç—É—Å–∞ (Done/Rejected) */
        .status-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; opacity: 0; pointer-events: none; 
            transition: opacity 0.4s ease;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: 900; color: white; text-transform: uppercase;
        }

        .success-mode .status-overlay { opacity: 1; background: rgba(40, 167, 69, 0.8); backdrop-filter: blur(4px); }
        .success-mode .status-overlay::after { content: "PASSED"; }

        .fail-mode .status-overlay { opacity: 1; background: rgba(220, 53, 69, 0.8); backdrop-filter: blur(4px); }
        .fail-mode .status-overlay::after { content: "REJECTED"; }

        #debug-status { position: fixed; bottom: 5px; right: 5px; color: lime; font-size: 10px; background: rgba(0,0,0,0.7); padding: 2px 5px; opacity: 0.3; }
    </style>
</head>
<body>

<div id="widget-container">
    <div class="obs-card" id="card-el">
        <div class="status-overlay"></div>
        <div class="cover-img"></div>
        <div class="info-block">
            <div class="label-now">üî¥ Now Requesting</div>
            <div class="map-title" id="title">Waiting for data...</div>
            <div class="requester">Requested by: <b id="user" style="color: #44ddff">---</b></div>
        </div>
    </div>
</div>

<div id="debug-status">Connecting...</div>

<script>
    // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ Render (polling + websocket)
    const socket = io({
        transports: ["polling", "websocket"],
        upgrade: true
    });

    const container = document.getElementById('widget-container');
    const cardEl = document.getElementById('card-el');
    const titleEl = document.getElementById('title');
    const userEl = document.getElementById('user');
    const debugEl = document.getElementById('debug-status');
    let resetTimer;

    socket.on('connect', () => { 
        debugEl.innerText = "Connected"; 
        debugEl.style.color = "lime"; 
    });

    socket.on('disconnect', () => { 
        debugEl.innerText = "Disconnected"; 
        debugEl.style.color = "red"; 
    });

    socket.on('update_obs', function(data) {
        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç—É—Å—ã –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏
        resetState();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        titleEl.innerText = data.map_name;
        userEl.innerText = data.user;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω —á–µ—Ä–µ–∑ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        const bg = data.bg_url || 'https://osu.ppy.sh/images/layout/beatmaps/default-bg.jpg';
        document.documentElement.style.setProperty('--bg-url', `url('${bg}')`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç
        container.classList.add('active');
    });

    socket.on('signal_obs_done', function() { 
        showStatus('success-mode', 3000); 
    });

    socket.on('signal_obs_rejected', function() { 
        showStatus('fail-mode', 2000); 
    });

    function showStatus(modeClass, delay) {
        container.classList.remove('success-mode', 'fail-mode'); // –ß–∏—Å—Ç–∏–º
        container.classList.add(modeClass);
        
        clearTimeout(resetTimer);
        resetTimer = setTimeout(() => {
            container.classList.remove('active');
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç
            setTimeout(() => {
                resetState();
                titleEl.innerText = "Waiting for request...";
                userEl.innerText = "---";
            }, 600);
        }, delay); 
    }

    function resetState() {
        container.classList.remove('success-mode', 'fail-mode');
        clearTimeout(resetTimer);
    }
</script>
</body>
</html>




